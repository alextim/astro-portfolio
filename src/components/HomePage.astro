---
export interface Props {
  locale: string;
}

import { getPage } from '@/cms/page';

import Layout from '@/components/Layout.astro';

import Hero from '@/components/Hero.astro';
import Services from '@/components/sections/Services.astro';
import About from '@/components/sections/About.astro';
import Gallery from '@/components/sections/Gallery.astro';
import Testimonials from '@/components/sections/Testimonials.astro';
import Contacts from '@/components/sections/Contacts.astro';
import { getSection } from '@/cms/section';

const { locale } = Astro.props as Props;

const sections = (await Astro.glob('/content/sections/*.??.md'))
  .map(getSection)
  .filter((section) => section.locale === locale);

const findSectionById = (id: string) => {
  const section = sections.find((item) => item.id === id);
  if (!section) {
    throw new Error(`Section with id=${id} not found`);
  }
  return section;
};

const services = findSectionById('services');
const about = await findSectionById('about');
const gallery = await findSectionById('gallery');
const testimonials = await findSectionById('testimonials');
const contacts = await findSectionById('contacts');

const home = (await Astro.glob('/content/pages/home.??.md'))
  .map(getPage)
  .find((p) => p.locale === locale && p.slug === '/');
if (!home) {
  throw new Error(`Home page for ${locale} is required`);
}

const { title, headline, metaTitle, metaDescription, noindex, nofollow } = home;

const seo = {
  title: metaTitle || title,
  description: metaDescription || headline,
  headline,
  noindex,
  nofollow,
};
---

<Layout seo={seo}>
  <Hero page={home} />
  <Services section={services} />
  <About section={about} />
  <Gallery section={gallery} />
  <Testimonials section={testimonials} />
  <Contacts section={contacts} />
</Layout>
