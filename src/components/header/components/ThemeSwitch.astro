---
import { Icon } from 'astro-icon';

const THEME_SWITCH_ID = 'theme-switch';
---
<label class="theme-switch">
  <input id={THEME_SWITCH_ID} type="checkbox" />
  <Icon name="sun-regular" class="sun" />
  <Icon name="moon-regular" class="moon" />
</label>

<style lang="scss">
  .theme-switch {
    cursor: pointer;
    color: white;
  }

  .sun, .moon {
    width: 1rem;
    height: 1rem;
  }
  .moon {
    display: none;
  }

  #theme-switch {
    display: none;
    &:checked {
      & + .sun {
        display: none;
      }
      & ~ .moon {
        display: block;
      }
    }
  }
</style>

<script define:vars={{ THEME_SWITCH_ID }}>
  const DARK_THEME = 'dark';

  const isDarkThemeSet = window.localStorage && window.localStorage.theme === DARK_THEME;
  const isThemeStored = window.localStorage && 'theme' in window.localStorage;
  const isDarkPrefered = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

  const themeSwitch = document.getElementById(THEME_SWITCH_ID);

  const setToDark = isDarkThemeSet || (!isThemeStored && isDarkPrefered);
  document.documentElement.classList.toggle(DARK_THEME, setToDark);
  themeSwitch.checked = setToDark;

  const onClick = () => {
    const setToDark = themeSwitch.checked;
    document.documentElement.classList.toggle(DARK_THEME, setToDark);
    if (window.localStorage) {
      window.localStorage.theme = setToDark ? DARK_THEME : 'light';
    }
  };

  themeSwitch.addEventListener('click', onClick);
</script>
